<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <title>Oofy</title>

    <!--Open Sans Font [ OPTIONAL ] -->
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700&amp;subset=latin" rel="stylesheet">

    <!--Bootstrap Stylesheet [ REQUIRED ]-->
    <link href="Pages/css/bootstrap.min.css" rel="stylesheet">

    <!--Nifty Stylesheet [ REQUIRED ]-->
    <link href="Pages/css/nifty.min.css" rel="stylesheet">

    <!--Font Awesome [ OPTIONAL ]-->
    <link href="Pages/plugins/font-awesome/css/font-awesome.min.css" rel="stylesheet">

    <!--Switchery [ OPTIONAL ]-->
    <link href="Pages/plugins/switchery/switchery.min.css" rel="stylesheet">

    <!--Bootstrap Select [ OPTIONAL ]-->
    <link href="Pages/plugins/bootstrap-select/bootstrap-select.min.css" rel="stylesheet">

    <!--Demo [ DEMONSTRATION ]-->
    <link href="Pages/css/demo/nifty-demo.min.css" rel="stylesheet">

    <!--Chosen [ OPTIONAL ]-->
    <link href="Pages/plugins/chosen/chosen.min.css" rel="stylesheet">

    <!--SCRIPT-->
    <!--=================================================-->

    <!--jQuery [ REQUIRED ]-->
    <script src="Pages/js/jquery-2.1.1.min.js"></script>

    <!--Dropzone [ OPTIONAL ]-->
    <link href="Pages/js/dropzone/dropzone.min.css" rel="stylesheet">

    <script src="Pages/js/d3.v5.min.js"></script>

    <script type="text/javascript">
        $(function () {
            function uuidv4() {
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                    var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
            }

            var uuid = localStorage.getItem("uuid");
            if (!uuid) {
                uuid = uuidv4();
                localStorage.setItem("uuid", uuidv4());
            }

            console.log(uuid);

            var mont_dict = {
                "01": "Jan",
                "02": "Feb",
                "03": "Mar",
                "04": "Apr",
                "05": "May",
                "06": "Jun",
                "07": "Jul",
                "08": "Aug",
                "09": "Sep",
                "10": "Oct",
                "11": "Nov",
                "12": "Dec"
            };
            var tmp_dataset = {};
            var total_money = 0;
            var active_year = 0;
            $.ajax({
                type: 'GET',
                url: 'https://42q6iw44o2.execute-api.ap-southeast-1.amazonaws.com/api/transactions/' + uuid,
                dataType: "text",
                success: function (data) {
                    tmp_dataset = {};
                    total_money = 0;
                    var parsedCSV = d3.csvParseRows(data);
                    parsedCSV.shift();
                    for (var idx in parsedCSV) {
                        var cells = parsedCSV[idx];
                        var year = cells[5].split("-")[0];
                        var month = mont_dict[cells[5].split("-")[1]];
                        var category = cells[6];
                        if (!tmp_dataset[year]) {
                            tmp_dataset[year] = {}
                        }
                        if (!tmp_dataset[year][month]) {
                            tmp_dataset[year][month] = {}
                        }
                        if (!tmp_dataset[year][month][category]) {
                            tmp_dataset[year][month][category] = 0
                        }
                        var money = parseFloat(cells[3].replace(',', '').replace('CR', '').replace(' ', ''));
                        tmp_dataset[year][month][category] += money;
                        total_money += money;
                    }

                    d3.select("#years_button").selectAll("*").remove();
                    Object.keys(tmp_dataset).forEach(function (key) {
                        d3.select("#years_button").append("button").attr("class", "btn btn-default btn-active-purple").attr("name", "year_button_i").text(key);
                    });
                    $("button[name='year_button_i']").click(function () {
                        $("button[name='year_button_i']").removeClass("active");
                        $(this).addClass("active");
                        active_year = $(this).text();
                    });
                }
            });

            function getRandomColor() {
                var letters = '0123456789ABCDEF';
                var color = '#';
                for (var i = 0; i < 6; i++) {
                    color += letters[Math.floor(Math.random() * 16)];
                }
                return color;
            }


            $("a[name='tabs_month']").click(function () {
                var current_year = active_year;
                if (!tmp_dataset[current_year] || !tmp_dataset[current_year][this.text]) {
                    d3.select("#head_of_chart").text("No data");
                    d3.select("#panel_bar").selectAll("*").remove();
                    d3.select("#demo-flot-donut").selectAll("*").remove();
                    return;
                }

                d3.select("#head_of_chart").text("Rate of Each Category");
                var tmp = tmp_dataset[current_year][this.text];
                var chart_data = [];
                var panel_bar = d3.select("#panel_bar");
                panel_bar.selectAll("*").remove();

                Object.keys(tmp).forEach(function (key) {
                    var color = getRandomColor();
                    // data for pie chart
                    chart_data.push({label: key, data: tmp[key].toFixed(2), color: color});
                    // rebuild progress bar
                    panel_bar.append("p").text(key);
                    var percent = (parseFloat(tmp[key]) / total_money * 100).toFixed(2) + "%";
                    panel_bar.append("div").attr("class", "progress").append("div").style("width", percent).style("background-color", color).attr("class", "progress-bar progress-bar-info").text("$ " + tmp[key].toFixed(2));
                });
                // rebuild pie chart
                $.plot('#demo-flot-donut', chart_data, {
                    series: {
                        pie: {
                            show: true,
                            combine: {
                                color: '#999',
                                threshold: 0.1
                            }
                        }
                    },
                    legend: {
                        show: false
                    }
                });

            });

            var categories = ["Auto Insurance",
                "Auto Payment",
                "Gas & Fuel",
                "Parking",
                "Public Transportation",
                "Service & Parts",
                "Home Phone",
                "Internet",
                "Mobile Phone",
                "Television",
                "Utilities",
                "Advertising",
                "Legal",
                "Office Supplies",
                "Printing",
                "Shipping",
                "Books & Supplies",
                "Student Loan",
                "Tuition",
                "Amusement",
                "Arts",
                "Movies & DVDs",
                "Music",
                "Newspapers & Magazines",
                "ATM Fee",
                "Bank Fee",
                "Finance Charge",
                "Late Fee",
                "Service Fee",
                "Trade Commissions",
                "Financial Advisor",
                "Life Insurance",
                "Alcohol & Bars",
                "Coffee Shops",
                "Fast Food",
                "Groceries",
                "Restaurants",
                "Charity",
                "Gift",
                "Dentist",
                "Doctor",
                "Eyecare",
                "Gym",
                "Health Insurance",
                "Pharmacy",
                "Sports",
                "Furnishings",
                "Home Improvement",
                "Home Insurance",
                "Home Services",
                "Home Supplies",
                "Lawn & Garden",
                "Mortgage & Rent",
                "Bonus",
                "Interest Income",
                "Paycheck",
                "Reimbursement",
                "Rental Income",
                "Returned Purchase",
                "Allowance",
                "Baby Supplies",
                "Babysitter & Daycare",
                "Child Support",
                "Kids Activities",
                "Toys",
                "Hair",
                "Laundry",
                "Spa & Massage",
                "Pet Food & Supplies",
                "Pet Grooming",
                "Veterinary",
                "Books",
                "Clothing",
                "Electronics & Software",
                "Hobbies",
                "Sporting Goods",
                "Federal Tax",
                "Local Tax",
                "Property Tax",
                "Sales Tax",
                "State Tax",
                "Credit Card Payment",
                "Transfer for Cash Spending",
                "Air Travel",
                "Hotel",
                "Rental Car & Taxi",
                "Vacation",
                "Cash & ATM",
                "Check"];

            var data = ",Unnamed: 0,date,description,amount,foreign_amount,statement_date,category\n" +
                "0,0,02 AUG,30 JUL NTUC FP-CITY SQUARE SINGAPORE,46.75,,2017-08-27 00:00:00,Groceries\n" +
                "1,1,05 AUG,02 AUG TIM HO WAN @ 112 KATONG SINGAPORE,45.79,,2017-08-27 00:00:00,Restaurants\n" +
                "2,2,07 AUG,03 AUG YAYOI JAPANESE RESTAURANTSINGAPORE,76.62,,2017-08-27 00:00:00,Restaurants\n";

            Dropzone.options.data = {
                paramName: 'file',
                maxFilesize: 20, // MB
                maxFiles: 3,
                timeout: 60000,
                dictDefaultMessage: 'Drag an image here to upload, or click to select one',
                uploadMultiple: false,
                autoProcessQueue: true,
                headers: {
                    //'x-csrf-token': document.querySelectorAll('meta[name=csrf-token]')[0].getAttributeNode('content').value,
                },
                acceptedFiles: '.pdf',
                init: function () {
                    this.on('success', function (file, resp) {
                        var data = resp.csv;
                        console.log(data);
                        var parsedCSV_o = d3.csvParseRows(data);
                        var parsedCSV = d3.csvParseRows(data);

                        for (var idx in parsedCSV) {
//                parsedCSV[idx].shift();
                            parsedCSV[idx].shift();
//                categories.push(parsedCSV[idx].pop())
                        }

                        var table = d3.select("#table_div").append("table").attr("class", "table table-striped table-bordered");

                        var tbody = table.append("tbody");
                        var thead = table.append('thead');

                        var columns = parsedCSV.shift();


                        // append the header row
                        thead.append('tr')
                            .selectAll('th')
                            .data(columns).enter()
                            .append('th')
                            .text(function (column) {
                                return column;
                            });


                        // create a row for each object in the data
                        var rows = tbody.selectAll('tr')
                            .data(parsedCSV)
                            .enter()
                            .append('tr');

                        // create a cell in each row for each column
                        var cells = rows.selectAll('td')
                            .data(function (row) {
                                return columns.map(function (column) {
                                    var value = row.shift();
                                    if (column === "category") {
                                        var select_html = '<select data-placeholder="Choose a Category..." name="demo-chosen-select">\n';
                                        for (idx in categories) {
                                            if (value === categories[idx]) {
                                                select_html += '<option value="' + categories[idx] + '" selected="selected">' + categories[idx] + '</option>\n'
                                            } else {
                                                select_html += '<option value="' + categories[idx] + '">' + categories[idx] + '</option>\n'
                                            }
                                        }
                                        select_html += '</select>\n';
                                        return {
                                            column: column,
                                            value: select_html
                                        };

                                    } else {
                                        return {column: column, value: value};
                                    }
                                });
                            })
                            .enter()
                            .append('td')
                            .html(function (d) {
                                return d.value;
                            });

                        $("select[name='demo-chosen-select']").chosen();

                        d3.select("#submit_api2").on('click', function () {
                            var category = [];
                            $("select[name='demo-chosen-select'] option:selected").each(function () {
                                category.push($(this).text())
                            });

                            for (var idx in parsedCSV_o) {
                                if (idx === "0") continue;
                                parsedCSV_o[idx].pop();
                                parsedCSV_o[idx].push(category.pop())
                            }
                            var new_csv = d3.csvFormat(parsedCSV_o);
                            var new_csv_a = new_csv.split("\n");
                            var new_csv_f = "";
                            for (idx in new_csv_a) {
                                if (idx === "0") continue;
                                new_csv_f += new_csv_a[idx] + "\n";
                            }
                            $.ajax({
                                type: 'POST',
                                url: 'https://42q6iw44o2.execute-api.ap-southeast-1.amazonaws.com/api/confirm',
                                dataType: "text",
                                data: {
                                    'uuid': uuid,
                                    'file': new_csv_f
                                },
                                success: function (data) {
                                    //hide the table

                                }
                            });
                        });
                    });
                    this.on("sending", function (file, xhr, formData) {
                        // Will send the filesize along with the file as POST data.
                        formData.append("filesize", file.size);
                    });
                }
            };
        });

    </script>
</head>
<body>

<!--Default Tabs (Left Aligned)-->
<!--===================================================-->
<div class="tab-base">
    <!--Tabs Content-->
    <div class="tab-content">
        <div class="panel">
            <div class="panel-heading">
                <h3 class="panel-title">Upload Documents</h3>
            </div>
            <div class="panel-body">

                <!--Dropzonejs-->
                <!--===================================================-->
                <form id="data" action="https://42q6iw44o2.execute-api.ap-southeast-1.amazonaws.com/api/upload"
                      method="post" class="dropzone">
                    <div class="dz-default dz-message">
                        <div class="dz-icon icon-wrap icon-circle icon-wrap-md">
                            <i class="fa fa-cloud-upload fa-3x"></i>
                        </div>
                        <div>
                            <p class="dz-text">Drop files to upload</p>
                            <p class="text-muted">or click to pick manually</p>
                        </div>
                    </div>
                    <div class="fallback">
                        <input name="file" type="file"/>
                    </div>
                </form>
                <!--===================================================-->
                <!-- End Dropzonejs -->

            </div>
            <div class="panel">
                <div class="panel-heading">
                    <h3 class="panel-title">Statements</h3>
                </div>
                <!--Tabs Content-->
                <div class="tab-content">
                    <div id="demo-stk-lft-tab-1" class="tab-pane fade active in">
                        <!-- Basic Data Tables -->
                        <!--===================================================-->
                        <div class="panel">
                            <div class="panel-body" id="table_div">
                            </div>
                            <div class="panel-footer text-right">
                                <button class="btn btn-info" id="submit_api2">Submit</button>
                            </div>
                        </div>
                        <!--===================================================-->
                        <!-- End Striped Table -->
                    </div>
                </div>
            </div>
            <div class="panel">
                <div class="panel-heading">
                    <div class="col-lg-12">
                        <h3 class="panel-title">Charts</h3>
                    </div>
                </div>
            </div>

        </div>
        <div class="btn-toolbar">
            <div id="years_button" class="btn-group">
            </div>
        </div>
        <!--===================================================-->
        <div class="panel-body">
            <!--Stacked Tabs Left-->
            <!--===================================================-->
            <div class="tab-base tab-stacked-left">
                <!--Nav tabs-->
                <ul class="nav nav-tabs">
                    <li class="active">
                        <a name="tabs_month" data-toggle="tab">Jan</a>
                    </li>
                    <li>
                        <a name="tabs_month" data-toggle="tab">Feb</a>
                    </li>
                    <li>
                        <a name="tabs_month" data-toggle="tab">Mar</a>
                    </li>
                    <li>
                        <a name="tabs_month" data-toggle="tab">Apr</a>
                    </li>
                    <li>
                        <a name="tabs_month" data-toggle="tab">May</a>
                    </li>
                    <li>
                        <a name="tabs_month" data-toggle="tab">Jun</a>
                    </li>
                    <li>
                        <a name="tabs_month" data-toggle="tab">Jul</a>
                    </li>
                    <li>
                        <a name="tabs_month" data-toggle="tab">Aug</a>
                    </li>
                    <li>
                        <a name="tabs_month" data-toggle="tab">Sep</a>
                    </li>
                    <li>
                        <a name="tabs_month" data-toggle="tab">Oct</a>
                    </li>
                    <li>
                        <a name="tabs_month" data-toggle="tab">Nov</a>
                    </li>
                    <li>
                        <a name="tabs_month" data-toggle="tab">Dec</a>
                    </li>
                </ul>

                <!--Tabs Content-->
                <div class="tab-content">
                    <div id="demo-stk-lft-tab-2" class="tab-pane fade active in">
                        <div class="col-lg-4">
                            <div class="panel-heading">
                                <h3 id="head_of_chart" class="panel-title"></h3>
                            </div>
                            <div class="panel-body">
                                <!--Flot Donut Chart placeholder -->
                                <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
                                <div id="demo-flot-donut" style="height:500px;width:500px"></div>
                                <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
                            </div>
                        </div>
                        <div class="col-lg-6 col-lg-offset-1">
                            <div class="panel">
                                <div class="panel-body" id="panel_bar">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>
<!--===================================================-->
<!--End Default Tabs (Left Aligned)-->

<!--JAVASCRIPT-->
<!--=================================================-->

<script src="Pages/js/jquery-2.1.1.min.js"></script>

<!--Dropzone [ OPTIONAL ]-->
<script src="Pages/js/dropzone/dropzone.min.js"></script>

<!--BootstrapJS [ RECOMMENDED ]-->
<script src="Pages/js/bootstrap.min.js"></script>

<!--Bootstrap Select [ OPTIONAL ]-->
<script src="Pages/plugins/bootstrap-select/bootstrap-select.min.js"></script>

<!--Nifty Admin [ RECOMMENDED ]-->
<script src="Pages/js/nifty.min.js"></script>

<!--JAVASCRIPT-->
<!--=================================================-->

<!--Bootstrap Datepicker [ OPTIONAL ]-->
<script src="Pages/plugins/bootstrap-datepicker/bootstrap-datepicker.js"></script>

<!--Fast Click [ OPTIONAL ]-->
<script src="Pages/plugins/fast-click/fastclick.min.js"></script>

<!--Flot Chart [ OPTIONAL ]-->
<script src="Pages/plugins/flot-charts/jquery.flot.min.js"></script>
<script src="Pages/plugins/flot-charts/jquery.flot.resize.min.js"></script>


<!--Chosen [ OPTIONAL ]-->
<script src="Pages/plugins/chosen/chosen.jquery.min.js"></script>

!--Flot Pie Chart [ OPTIONAL ]-->
<script src="Pages/plugins/flot-charts/jquery.flot.pie.min.js"></script>

<!--Nifty Admin [ RECOMMENDED ]-->
<script src="Pages/js/nifty.min.js"></script>


<!--Switchery [ OPTIONAL ]-->
<script src="Pages/plugins/switchery/switchery.min.js"></script>


<!--Bootstrap Select [ OPTIONAL ]-->
<script src="Pages/plugins/bootstrap-select/bootstrap-select.min.js"></script>


<!--Demo script [ DEMONSTRATION ]-->
<script src="Pages/js/demo/nifty-demo.min.js"></script>


</body>
</html>